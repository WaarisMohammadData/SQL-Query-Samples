-- CALD CTE: Collects all billable orders for usage broken out by property types (Electric Consumption and Revenue Data).
WITH CALD AS (
    SELECT 
        SUBC.STATE_TX, 
        SUBC.START_MONTH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Residential' THEN SUBC.CALENDARIZED_USAGE / 1000 ELSE 0 END) RESI_MWH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Residential' THEN SUBC.CALENDARIZED_AMOUNT / 1000 ELSE 0 END) RESI_AMT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Commercial' THEN SUBC.CALENDARIZED_USAGE / 1000 ELSE 0 END) COMM_MWH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Commercial' THEN SUBC.CALENDARIZED_AMOUNT / 1000 ELSE 0 END) COMM_AMT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Industrial' THEN SUBC.CALENDARIZED_USAGE / 1000 ELSE 0 END) IND_MWH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Industrial' THEN SUBC.CALENDARIZED_AMOUNT / 1000 ELSE 0 END) IND_AMT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Transportation' THEN SUBC.CALENDARIZED_USAGE / 1000 ELSE 0 END) TRAN_MWH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Transportation' THEN SUBC.CALENDARIZED_AMOUNT / 1000 ELSE 0 END) TRAN_AMT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS IS NULL THEN SUBC.CALENDARIZED_USAGE / 1000 ELSE 0 END) NULL_MWH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS IS NULL THEN SUBC.CALENDARIZED_AMOUNT / 1000 ELSE 0 END) NULL_AMT
    FROM (
        SELECT 
            (CASE 
                WHEN I.OPERATING_CO_TX IN ('BusinessDivision1') THEN 'Residential' 
                WHEN I.OPERATING_CO_TX IN ('BusinessDivision2', 'BusinessDivision3', 'BusinessDivision4', 'BusinessDivision5', 'BusinessDivision6') 
                AND C.CUSTOMER_CLASS = 'Residential' THEN 'Residential' 
            END) AS CUSTOMER_CLASS,
            (DATEDIFF(DAY, 
                (CASE WHEN I.INVOICE_START_DT <= D.START_MONTH THEN D.START_MONTH ELSE I.INVOICE_START_DT END),
                (CASE WHEN I.INVOICE_END_DT <= D.END_MONTH THEN D.END_MONTH ELSE I.INVOICE_END_DT END)
            )) AS BILLABLE_DAYS
        FROM 
            ENERGY_INVOICE(nolock) I
            LEFT JOIN ENERGY_INVOICE_CUST_CLASS(nolock) C ON I.CUSTOMER_NAME_TX = C.CUSTOMER_NAME
            JOIN ENERGY_INVOICES_DATES_MONTH(nolock) D ON I.INVOICE_START_DT <= D.END_MONTH AND I.INVOICE_END_DT >= D.START_MONTH
        WHERE
            I.INVOICE_START_DT IS NOT NULL
            AND I.OPERATING_CO_TX NOT IN ('BusinessDivision3', 'BusinessDivision2', 'BusinessDivision4', 'BusinessDivision5', 'BusinessDivision6')
            AND I.DAILY_USAGE_NUM IS NOT NULL
-- 5-month lookback
            AND I.INVOICE_END_DT >= DATEADD(MONTH, -5, DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)) 
            AND D.END_MONTH >= DATEADD(MONTH, -5, DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)
            AND D.START_MONTH < DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)
    ) SUBC
    GROUP BY SUBC.STATE_TX, SUBC.START_MONTH
),

-- CALA CTE Portion: Collects all billable orders for usage broken out by property types (customer count)
CALA AS (
    SELECT 
        SUBC.STATE_TX, 
        SUBC.START_MONTH,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Residential' THEN 1 ELSE 0 END) RESI_LDCACCT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Commercial' THEN 1 ELSE 0 END) COMM_LDCACCT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Industrial' THEN 1 ELSE 0 END) IND_LDCACCT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS = 'Transportation' THEN 1 ELSE 0 END) TRAN_LDCACCT,
        SUM(CASE WHEN SUBC.CUSTOMER_CLASS IS NULL THEN 1 ELSE 0 END) NULL_LDCACCT
    FROM (
        SELECT DISTINCT 
            (CASE 
                WHEN I.OPERATING_CO_TX IN ('BusinessDivision1') THEN 'Residential' 
                WHEN I.OPERATING_CO_TX IN ('BusinessDivision2', 'BusinessDivision3', 'BusinessDivision4', 'BusinessDivision5', 'BusinessDivision6') 
                AND C.CUSTOMER_CLASS = 'Residential' THEN 'Residential' 
            END) AS CUSTOMER_CLASS
        FROM 
            ENERGY_INVOICES(nolock) I
            LEFT JOIN ENERGY_INVOICE_CUST_CLASS(nolock) C ON I.CUSTOMER_NAME_TX = C.CUSTOMER_NAME
            JOIN ENERGY_INVOICES_DATES_MONTH(nolock) D ON I.INVOICE_START_DT <= D.END_MONTH AND I.INVOICE_END_DT >= D.START_MONTH
        WHERE
            I.INVOICE_START_DT IS NOT NULL
            AND I.OPERATING_CO_TX NOT IN ('BusinessDivision3', 'BusinessDivision2', 'BusinessDivision4', 'BusinessDivision5', 'BusinessDivision6')
            AND I.DAILY_USAGE_NUM IS NOT NULL
-- 5-month lookback            
            AND D.END_MONTH >= DATEADD(MONTH, -5, DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)
            AND D.START_MONTH < DATEADD(MONTH, DATEDIFF(MONTH, 0, GETDATE()), 0)
    ) SUBC
    GROUP BY SUBC.STATE_TX, SUBC.START_MONTH
)

-- Bottom Portion: Combines data from CALD and CALA to calculate metrics like price per MWh and consumption per state and property type.
SELECT 
    D.STATE_TX, 
    D.START_MONTH, 
    A.RESI_LDCACCT, 
    D.RESI_MWH, 
    D.RESI_AMT, 
    A.COMM_LDCACCT, 
    D.COMM_MWH, 
    D.COMM_AMT, 
    A.IND_LDCACCT, 
    D.IND_MWH, 
    D.IND_AMT, 
    A.TRAN_LDCACCT, 
    D.TRAN_MWH, 
    D.TRAN_AMT, 
    A.NULL_LDCACCT, 
    D.NULL_MWH, 
    D.NULL_AMT,
    ((D.RESI_AMT/NULLIF(D.RESI_MWH, 0))*100) EIA_RES_PRICE, 
    (D.RESI_MWH/NULLIF(A.RESI_LDCACCT, 0)) EIA_RES_CONS, 
    ((D.COMM_AMT/NULLIF(D.COMM_MWH, 0))*100) EIA_COMM_PRICE, 
    (D.COMM_MWH/NULLIF(A.COMM_LDCACCT, 0)) EIA_COMM_CONS,
    ((D.IND_AMT/NULLIF(D.IND_MWH, 0))*100) EIA_IND_PRICE, 
    (D.IND_MWH/NULLIF(A.IND_LDCACCT, 0)) EIA_IND_CONS,
    ((D.TRAN_AMT/NULLIF(D.TRAN_MWH, 0))*100) EIA_TRAN_PRICE, 
    (D.TRAN_MWH/NULLIF(A.TRAN_LDCACCT, 0)) EIA_TRAN_CONS,
    ((D.NULL_AMT/NULLIF(D.NULL_MWH, 0))*100) EIA_NULL_PRICE, 
    (D.NULL_MWH/NULLIF(A.NULL_LDCACCT, 0)) EIA_NULL_CONS
FROM 
    CALD D
    LEFT JOIN CALA A ON D.STATE_TX = A.STATE_TX AND D.START_MONTH = A.START_MONTH
ORDER BY 
    D.STATE_TX, 
    D.START_MONTH;
